. "$top_srcdir"/library

dtf_prereq pkg installed postgresql-test
dtf_prereq pkg installed make

pgdtf_init_server_test
pgdtf_initdb_and_start

where={{ m.libdir }}/pgsql/test/regress/

su - postgres -c "make -C '$where' check"
rc=$?

if test $rc -ne 0; then
  find "$where" -name 'regression.diffs' | \
    while read line; do
      echo "file $line"
      cat "$line"
    done
fi

pgdtf_stop_and_clean

test $rc -eq 0 || dtf_fail "testsuite failed"
